name: Book 4 Charles

on:
  schedule:
    - cron: '35 13 * * *'
    - cron: '40 13 * * *'
    - cron: '45 13 * * *'
    - cron: '50 13 * * *'
    - cron: '55 13 * * *'
  workflow_dispatch:

jobs:
  book:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install poetry
          poetry install
      
      - name: Get fresh auth token and create credentials
        run: |
          # Login to Resy to get a fresh token
          RESPONSE=$(curl -s -X POST 'https://api.resy.com/3/auth/password' \
            -H 'Authorization: ResyAPI api_key="${{ secrets.RESY_API_KEY }}"' \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d 'email=${{ secrets.RESY_EMAIL }}&password=${{ secrets.RESY_PASSWORD }}')
          
          # Extract token from response
          FRESH_TOKEN=$(echo $RESPONSE | python -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          echo "Got fresh token"
          
          cat > credentials.json << EOF
          {
            "api_key": "${{ secrets.RESY_API_KEY }}",
            "token": "$FRESH_TOKEN",
            "payment_method_id": ${{ secrets.RESY_PAYMENT_ID }},
            "email": "${{ secrets.RESY_EMAIL }}",
            "password": "${{ secrets.RESY_PASSWORD }}"
          }
          EOF
      
      - name: Create reservation request
        run: |
          TARGET_DATE=$(date -d "+21 days" +%Y-%m-%d)
          cat > reservation_request.json << EOF
          {
            "reservation_request": {
              "party_size": 2,
              "venue_id": 834,
              "window_hours": 3,
              "prefer_early": false,
              "ideal_date": "$TARGET_DATE",
              "ideal_hour": 19,
              "ideal_minute": 0
            },
            "expected_drop_hour": "9",
            "expected_drop_minute": "0"
          }
          EOF
          echo "Targeting date: $TARGET_DATE"
      
      - name: Run Resy Bot
        run: |
          poetry run python main.py credentials.json reservation_request.json
